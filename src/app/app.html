<main class="app-container py-md-4 px-1">
  <div class="top-bar d-print-none mb-4 mx-auto shadow p-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3 text-white">
      <span class="fw-bold d-none d-sm-inline">Quick Invoice Editor</span>
      <div class="d-flex align-items-center gap-2">
        <select [ngModel]="currencyCode()" (ngModelChange)="currencyCode.set($event)" class="form-select form-select-sm" style="width: 89px;">
          <option value="USD">USD $</option>
          <option value="EUR">EUR €</option>
          <option value="GBP">GBP £</option>
          <option value="JPY">JPY ¥</option>
          <option value="INR">INR ₹</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary btn-sm px-4 fw-bold shadow-sm" (click)="downloadPDF()">Download PDF</button>
  </div>

  <div class="invoice-wrapper">
    <div class="invoice-page shadow mx-auto" id="printable" [class.cleaning]="isExporting">

      <header class="mb-4 text-start">
        <div class="logo-area mb-3">
          @if (logoUrl()) {
            <img [src]="logoUrl()" class="logo-img" (click)="logoInput.click()">
          } @else {
            <div class="logo-placeholder d-print-none" (click)="logoInput.click()">+ Upload Logo</div>
          }
          <input #logoInput type="file" (change)="onLogoChange($event)" hidden>
        </div>
        <div class="business-info">
          <div contenteditable="true" class="input-ghost h5 fw-bold mb-1 w-100"
               (input)="businessName = $any($event.target).innerText">{{businessName}}</div>
          <div contenteditable="true" class="input-ghost small text-muted w-100"
               (input)="businessAddress = $any($event.target).innerText">{{businessAddress}}</div>
        </div>
      </header>

      <div class="divider-line mb-4"></div>

      <section class="mb-5 text-start">
        <span class="label-tag text-dark">Bill To</span>
        <div contenteditable="true" class="input-ghost fw-bold mb-1 w-100"
             (input)="clientName = $any($event.target).innerText">{{clientName}}</div>
        <div contenteditable="true" class="input-ghost small text-muted w-100"
             (input)="clientAddress = $any($event.target).innerText">{{clientAddress}}</div>
      </section>

      <div class="invoice-header-row d-flex justify-content-between align-items-end mb-4 pb-2 border-bottom">
        <div class="text-start">
          <h2 class="h5 fw-bold m-0 text-uppercase letter-spacing-1">Invoice</h2>
        </div>
        <div class="d-flex gap-4 text-end">
          <div>
            <span class="label-tag">Number</span>
            <input class="input-ghost small text-end" style="width: 100px" [(ngModel)]="invoiceNumber" />
          </div>
          <div>
            <span class="label-tag">Date</span>
            <input type="date" class="input-ghost small text-end" [(ngModel)]="invoiceDate" />
          </div>
        </div>
      </div>

      <div class="table-responsive mb-3">
        <table class="table align-middle">
          <thead>
            <tr class="table-blue-header bg-light">
              <th class="ps-2" style="width: 35%">Description</th>
              <th class="text-center" style="width: 10%">Qty</th>
              <th class="text-end" style="width: 15%">Price</th>
              <th class="text-center" style="width: 12%">Disc %</th>
              <th class="text-end pe-2" style="width: 18%">Amount</th>
              <th class="d-print-none" style="width: 40px"></th>
            </tr>
          </thead>
          <tbody>
            @for (item of items(); track item.id) {
              <tr class="item-row">
                <td><div contenteditable="true" class="td-input w-100"
                         (input)="item.description = $any($event.target).innerText">{{item.description}}</div></td>
                <td><input type="number" class="td-input text-center w-100" [(ngModel)]="item.quantity" (ngModelChange)="updateTotals()" /></td>
                <td><input type="number" class="td-input text-end w-100" [(ngModel)]="item.price" (ngModelChange)="updateTotals()" /></td>
                <td><input type="number" class="td-input text-center w-100" [(ngModel)]="item.discount" (ngModelChange)="updateTotals()" /></td>
                <td class="text-end fw-normal">
                  {{ (item.quantity * item.price * (1 - (item.discount || 0)/100)) | currency: currencyCode() }}
                </td>
                <td class="d-print-none text-center">
                  <button class="btn-remove" (click)="removeItem(item.id)">×</button>
                </td>
              </tr>
            }
          </tbody>
        </table>
        <button class="btn btn-sm btn-outline-primary w-100 py-2 d-print-none" (click)="addItem()">+ Add Item</button>
      </div>

      <div class="d-flex justify-content-end mt-4">
        <div class="col-7 col-md-5 text-end">
          <div class="d-flex justify-content-between mb-1 small">
            <span class="text-muted">Subtotal</span>
            <span>{{ subTotal() | currency: currencyCode() }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2 align-items-center small">
            <span class="text-muted">Tax (<input type="number" [ngModel]="taxRate()" (ngModelChange)="taxRate.set($event)" class="tax-input" />%)</span>
            <span>{{ taxAmount() | currency: currencyCode() }}</span>
          </div>
          <div class="d-flex justify-content-between border-top border-dark pt-2 mt-2 fw-bold">
            <span class="h6 m-0 text-uppercase">TOTAL</span>
            <span class="h5 m-0 text-dark">{{ total() | currency: currencyCode() }}</span>
          </div>
        </div>
      </div>

      <footer class="notes-footer mt-auto pt-4">
        <span class="label-tag text-dark">Notes & Payment Terms</span>
        <div contenteditable="true" class="input-ghost small text-muted w-100"
             (input)="footerNote = $any($event.target).innerText">{{footerNote}}</div>
      </footer>
    </div>
  </div>
  <p class="text-center mt-4"><a href="https://emilioparodi.dev" target="_blank">Made by ƎP Dev.</a></p>
</main>
